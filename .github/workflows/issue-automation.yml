name: Issue Automation

on:
  push:
    branches: [main, develop, 'feature/*']
  pull_request:
    branches: [main, develop, 'feature/*']

jobs:
  issue-tracking:
    name: Track Issue Progress
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for commit analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run issue automation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_BEFORE: ${{ github.event.before }}
          GITHUB_EVENT_AFTER: ${{ github.event.after }}
        run: node scripts/update-issues.js

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        run: |
          echo "üí¨ Adding automation comment to PR..."

          # Extract issue numbers from PR title and body
          ISSUE_NUMBERS=$(echo "${{ github.event.pull_request.title }} ${{ github.event.pull_request.body }}" | grep -o '#[0-9]\+' | sort -u | sed 's/#//')

          if [ -n "$ISSUE_NUMBERS" ]; then
            COMMENT_BODY="ü§ñ **SprintFlow CI/CD Pipeline Report**
            
            ## üìä Issue Progress
            
            Related issues: $ISSUE_NUMBERS
            
            ## üîç Quality Gates
            
            - [x] Code quality checks
            - [x] TypeScript validation
            - [x] Test execution
            - [x] Build verification
            
            ## üìà Next Steps
            
            This PR is ready for review. Once approved and merged, related issues will be automatically updated.
            
            ---
            *Report generated by SprintFlow automation*"
            
            curl -s -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -d "{\"body\":\"$COMMENT_BODY\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
